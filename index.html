<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://localhost/prova-pw3/style.css">
    <title>Roupas top</title>
    
</head>
<body>
    
    <div>
        <input type="hidden" id="id">
        <input type="text" id="categoria" placeholder="Categoria">
        <input type="text" id="preco" placeholder = "Preço">
        
        <select id="disponivel">
        <option value="1">Disponível</option>
        <option value="0">Indisponível </option>
        </select>
        <button onclick="salvar()"> Salvar</button>
        <button onclick="limpar()">Cancelar</button>
        </div>
        <div>
            <input type="text" id="pesquisa" placeholder="Pesquisar por categoria">
            <button onclick="carregarPesquisa()">Pesquisar</button>
            <button onclick="carregar()">Listar Todos</button>
        </div>
        <table id="tabela">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Categoria</th>
                    <th>Preço</th>
                    <th>Disponivel</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script>
            const API_URL="http://localhost/prova-pw3/roupas.php";
            function carregar(pesquisa = ""){
                let url = API_URL;
                if(pesquisa){
                    url += "?pesquisa=" + encodeURIComponent(pesquisa);
                }
                fetch(url)
                .then(resposta=> resposta.json())
                .then(dados=>{
                    console.log(dados)
                    dados.forEach(roupa => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${roupa.Id}</td>
                            <td>${roupa.categoria}</td>
                            <td>${roupa.preco}</td>
                            <td>${roupa.disponivel == 1? "Sim" : "Não"}</td>
                            <td>
                                <button onclick='editar(${JSON.stringify(roupa)})'>Editar</button>
                                <button onclick='excluir(${roupa.Id})'>Excluir</button>
                            </td>
                            `;
                    tbody.appendChild(tr);
                    });
                })
            const tbody = document.querySelector("#tabela tbody");
            tbody.innerHTML= "";
            }

            function carregarPesquisa(){
                const valor = document.getElementById("pesquisa").value;
                carregar(valor);
            }

            async function salvar() {
                const id = document.getElementById("id").value;
                const categoria = document.getElementById("categoria").value;
                const preco = document.getElementById("preco").value;
                const disponivel = document.getElementById("disponivel").value;

                const payload = {Id: id, categoria: categoria, preco: preco, disponivel: disponivel};

                if (id) {
                    await fetch(API_URL, { method: "PUT", body: JSON.stringify(payload) });
                } else{
                    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                }
                
                limpar();
                carregar();
            }

            function editar(roupa){
                document.getElementById("id").value= roupa.Id;
                document.getElementById("categoria").value = roupa.categoria;
                document.getElementById("preco").value = roupa.preco;
                document.getElementById("disponivel").value = roupa.disponivel;
            }
            
            async function excluir(id) {
                if(confirm("Tem certeza que quer excluir esta cadastro de roupa??? ")){
                    await fetch(API_URL + "?id=" + id, {method: "DELETE"});
                    carregar();
                }
            }

            function limpar(){
                document.getElementById("id").value= "";
                document.getElementById("categoria").value="";
                document.getElementById("preco").value = "";
                document.getElementById("disponivel").value = "";
            }
            carregar();
        
    </script>
</body>
</html>